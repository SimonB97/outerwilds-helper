<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outer Wilds Save Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-upload-label {
            cursor: pointer;
        }
        .log-entry-text {
            background-color: #1f2937; /* gray-800 */
            border-left: 3px solid #4f46e5; /* indigo-600 */
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
            border-radius: 0.25rem;
        }
        .entry-unfound .log-entry-text {
             border-left-color: #6b7280; /* gray-500 */
        }
        .spoiler {
            background-color: #374151; /* gray-700 */
            color: #374151;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0 0.25rem;
            transition: all 0.3s ease-in-out;
            user-select: none; /* Prevent text selection when covered */
            cursor: pointer;
        }
        .spoiler.revealed {
            background-color: transparent;
            color: inherit;
            user-select: auto;
            cursor: default;
        }
        .collapsible-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chevron {
            transition: transform 0.2s ease-in-out;
        }
        .chevron.collapsed {
            transform: rotate(-90deg);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex items-center justify-center p-4 sm:p-6 lg:p-8">
    <main class="w-full max-w-5xl bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-8 md:p-10 space-y-8">
        <header class="text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">Outer Wilds Save Analyzer</h1>
            <p class="text-gray-400 mt-2">Upload your <code class="bg-gray-700 text-amber-400 p-1 rounded-md">*.owsave</code> binary file to see your progress.</p>
        </header>

        <!-- File Upload Section -->
        <section id="upload-section">
            <div class="flex items-center justify-center w-full">
                <label for="file-upload" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-600 border-dashed rounded-lg file-upload-label bg-gray-700 hover:bg-gray-600 transition-colors">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h5l4 4h2a4 4 0 014 4v5a4 4 0 01-4 4H7z"></path></svg>
                        <p class="mb-2 text-sm text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                        <p id="file-name" class="text-xs text-gray-500">No file selected</p>
                    </div>
                    <input id="file-upload" type="file" class="hidden" accept=".owsave" />
                </label>
            </div>
             <div class="mt-4">
                <p class="text-xs text-gray-500 text-center mb-3">Your save file is usually located at:</p>
                <div class="space-y-2 text-xs text-gray-500">
                    <div class="bg-gray-700/30 p-3 rounded-lg">
                        <p class="font-semibold text-gray-400 mb-1">Microsoft Store:</p>
                        <code class="bg-gray-700 p-1 rounded-md break-all">%LOCALAPPDATA%\Packages\AnnapurnaInteractive.OuterWilds_c96c51jf6wkvm\SystemAppData\wgs\</code>
                    </div>
                    <div class="bg-gray-700/30 p-3 rounded-lg">
                        <p class="font-semibold text-gray-400 mb-1">Windows (General):</p>
                        <code class="bg-gray-700 p-1 rounded-md break-all">%USERPROFILE%\AppData\LocalLow\Mobius Digital\Outer Wilds\Saves\</code>
                    </div>
                    <div class="bg-gray-700/30 p-3 rounded-lg">
                        <p class="font-semibold text-gray-400 mb-1">Steam:</p>
                        <code class="bg-gray-700 p-1 rounded-md break-all">%USERPROFILE%\AppData\LocalLow\Mobius Digital\Outer Wilds\SteamSaves\</code>
                    </div>
                    <div class="bg-gray-700/30 p-3 rounded-lg">
                        <p class="font-semibold text-gray-400 mb-1">Steam Play (Linux):</p>
                        <code class="bg-gray-700 p-1 rounded-md break-all">/steamapps/compatdata/753640/pfx/</code>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Analysis Output Section -->
        <section id="analysis-output" class="hidden space-y-8">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <h2 class="text-2xl font-semibold text-white">Analysis Summary</h2>
                <div class="flex items-center space-x-4">
                    <label for="spoiler-toggle" class="text-sm font-medium text-gray-300">Reveal All Spoilers</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="spoiler-toggle" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-800 peer-checked:bg-blue-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                    </label>
                </div>
            </div>

            <div id="game-progress" class="bg-gray-700/50 p-6 rounded-lg"></div>
            <div id="ship-logs-summary" class="bg-gray-700/50 p-6 rounded-lg"></div>
            <div id="key-conditions" class="bg-gray-700/50 p-6 rounded-lg"></div>
            <div id="major-locations" class="bg-gray-700/50 p-6 rounded-lg"></div>
            <div id="detailed-ship-log" class="bg-gray-700/50 p-6 rounded-lg"></div>

             <div class="text-center pt-4">
                <button id="reset-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Analyze Another File</button>
            </div>
        </section>
    </main>

    <!-- Spoiler Warning Modal -->
    <div id="spoiler-warning-modal" class="modal-overlay hidden">
        <div class="bg-gray-800 border border-gray-600 rounded-lg shadow-xl p-6 w-full max-w-md text-center space-y-4">
            <h3 class="text-xl font-bold text-amber-400">Spoiler Warning!</h3>
            <p class="text-gray-300">You are about to reveal an undiscovered fact. Are you sure you want to continue?</p>
            <div class="flex items-center justify-center space-x-2 text-sm">
                <input type="checkbox" id="dismiss-spoiler-warning" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-500 rounded focus:ring-blue-600">
                <label for="dismiss-spoiler-warning" class="text-gray-400">Don't show this again</label>
            </div>
            <div class="flex justify-center gap-4 pt-2">
                <button id="cancel-reveal-button" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold transition-colors">Cancel</button>
                <button id="confirm-reveal-button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md font-semibold text-white transition-colors">Reveal</button>
            </div>
        </div>
    </div>


    <script>
        // --- Global State ---
        let currentSaveData = null;
        let spoilerWarningDismissed = false;
        let activeSpoilerElement = null;

        // --- DATA MAPPINGS ---
        const locationNames = {
            'TH': 'Timber Hearth', 'TM': 'The Attlerock', 'BH': 'Brittle Hollow', 'GD': "Giant's Deep", 
            'DB': 'Dark Bramble', 'CT': 'The Interloper', 'TT': 'Ash Twin', 'ET': 'Ember Twin',
            'S': 'Sun Station', 'SS': 'Sun Station', 'QUANTUM': 'Quantum Moon', 'QM': 'Quantum Moon', 'ORBITAL': 'Orbital Probe Cannon', 
            'OPC': 'Orbital Probe Cannon', 'VM': 'Hollow\'s Lantern', 'WHS': 'White Hole Station', 'COMET': 'The Interloper', 
            'IP': 'The Stranger (DLC)'
        };

        const storyConditions = {
            'MET_RIEBECK': 'Met Riebeck', 'TALKED_TO_GABBRO': 'Talked to Gabbro', 'ChertFirstContact': 'Met Chert',
            'HAS_USED_TRANSLATOR': 'Used Nomai translator', 'LAUNCH_CODES_GIVEN': 'Received launch codes',
            'HAS_USED_SHIPLOG': 'Used ship log', 'PREFLIGHT_CHECKLIST_UNLOCKED': 'Pre-flight checklist unlocked',
            'GABBRO_MERGE_TRIGGERED': 'Experienced the first loop with Gabbro'
        };

        const shipLogMapping = {
            'SS_SUN_STATION_X1': "The Sun Station was designed to make the sun go supernova.", 'SS_SUN_STATION_X2': "The Nomai fired the Sun Station but it had no effect on the sun. They concluded that the Sun Station could never cause the sun to go supernova.", 'SS_SUN_STATION_X3': "After the failure of the Sun Station, the Nomai took a break to investigate the newly arrived comet.", 'SS_SUN_STATION_X4': "According to a Nomai computer, our sun has reached the end of its natural life cycle.", 'ET_ANGULAR_FISH_FOSSIL_X1': "Nomai children used to play a game here. One player was the anglerfish and wore a blindfold. The rest of the children (the littlefish) lined up against one wall. When the anglerfish said go, the littlefish had to sneak across to the other side.", 'ET_ANGULAR_FISH_FOSSIL_X2': "The blindfold rule was added because real anglerfish are blind.", 'ET_ANGULAR_FISH_FOSSIL_X3': "The adult Nomai were delighted to see the children incorporate their research into the game's rules.", 'ET_GRAVITY_CANNON_X1': "A huge cylindrical structure that generates a strong upward gravity field.", 'ET_GRAVITY_CANNON_X2': "I recalled a Nomai shuttle from the Interloper.", 'ET_CHERTS_CAMP_X1': "Chert has set up their astronomy gear on the north pole of Ember Twin.", 'ET_CHERTS_CAMP_X2': "Chert has spotted an unusually high number of supernovae recently.", 'ET_CHERTS_CAMP_X3': "All of the stars in the universe are dying, including our sun.", 'ET_CHERTS_CAMP_X4': "The stars are simply dying from old age. Apparently they're much older than we realized.", 'ET_CHERTS_CAMP_X5': "Chert has become catatonic in response to our sun's imminent death.", 'ET_ESCAPE_POD_X1': "One of three Nomai escape pods that crashed in our solar system.", 'ET_ESCAPE_POD_X2': "All three escape pods were launched from something called the Vessel, which was badly damaged.", 'ET_SUNLESS_CITY_X1': "A Nomai city built into the walls of a huge underground cavern. The city is divided vertically into four districts.", 'ET_SUNLESS_CITY_X2': "The Nomai debated building a Sun Station in order to power the Ash Twin Project. Several Nomai opposed its construction, arguing that failure could result in the destruction of the solar system.", 'ET_SUNLESS_CITY_X3': "The Nomai traveled to this solar system in pursuit of a signal from something older than the universe itself. The named the source of this signal the \"Eye of the universe.\"", 'ET_QUANTUM_MOON_LOCATOR_X1': "A Nomai device created to track the Quantum Moon's location.", 'ET_QUANTUM_MOON_LOCATOR_X2': "The Nomai hypothesized that the Quantum Moon might be a form of macroscropic quantum mechanics.", 'ET_QUANTUM_MOON_LOCATOR_X3': "The Quantum Moon travels to a total of five locations.", 'ET_HIGH_ENERGY_LAB_X1': "The Nomai successfully reproduced the temporal anomaly first observed at the White Hole Station (warped objects appear to arrive before they depart).", 'ET_HIGH_ENERGY_LAB_X2': "The Nomai discovered they could increase the negative time interval between arrival and departure by adding energy to the warp cores.", 'ET_HIGH_ENERGY_LAB_X3': "The Nomai wanted to know if a 22-minute negative time interval was possible. The concluded it would require new technology to produce the necessary energy as well as an advanced warp core to handle those energies. Ash Twin was proposed as a location for the project.", 'ET_TOWER_DESIGN_X1': "Designs for each of the towers on Ash Twin's equator.", 'ET_TOWER_DESIGN_X2': "Each tower warps to a different planet (although many Nomai were quick to note that the sun is not actually a planet).", 'ET_TOWER_DESIGN_X3': "Each tower was designed to visually reflect its warp destination.", 'ET_TOWER_DESIGN_X4': "The towers allowed the Nomai to quickly travel between the Ash Twin and all other locations crucial to the Ash Twin Project.", 'ET_QUANTUM_CAVES_X1': "The Nomai noticed a strange wandering rock that appeared in multiple caves on Ember Twin's northern hemisphere.", 'ET_QUANTUM_CAVES_X2': "I found a strange rock shard that moves when I'm not watching. It emits a signal on the Quantum Fluctuations frequency.", 'ET_LAKEBED_CAVE_X1': "A Nomai named Coleus was standing on the wandering rock when another Nomai's lantern died. When they relit the lantern, Coleus and the rock were both gone.", 'ET_LAKEBED_CAVE_X2': "To travel with a quantum object, I must stand on the object and cease to observe my surroundings (meaning I must be in complete darkness). Coleus used this quantum rule to escape the cave he was trapped in.", 'ET_LAKEBED_CAVE_X3': "Coleus and elorae returned to examine the rock. They theorized that when a conscious being is in contact with a quantum object and ceases to observe his or her surroundings, the being can become entangled with that quantum object, and they both move together.", 'TT_PROJECT_X1': "A hollowed-out chamber inside Ash Twin. The energy cables from the surface are plugged into a protective casing at the center of the planet.", 'TT_PROJECT_X2': "There are eight monoliths with Nomai masks attached. Three of the masks are actively receiving data from the Probe Tracking Module, Giant's Deep, and Timber Hearth respectively.", 'TT_PROJECT_X3': "The Ash Twin Project was designed to use the energy from a supernova (triggered by the Sun Station) to send probe data from the Orbital Probe Cannon 22 minutes into the past.", 'TT_PROJECT_X4': "The Sun Station did not work. Although the Ash Twin Project was theoretically sound, the Nomai were unable to power it.", 'TT_PROJECT_X5': "There is an advanced warp core inside the protective casing at the center of the planet. Removing the core will disable the Ash Twin Project.", 'TT_TOWERS_X1': "Several large Nomai towers form a ring around Ash Twin's equator.", 'TT_TOWERS_X2': "The White Hole Station was used as a model for these towers, which were built for the Ash Twin Project.", 'TH_VILLAGE_X1': "The one and only Hearthian village, as well as the main source of explosions on this planet.", 'TH_VILLAGE_X2': "The Nomai statue in the observatory opened its eyes and looked at me! I saw strange glowing lights and my own memories flashed before my eyes.", 'TH_VILLAGE_X3': "Hal says the statue has never opened its eyes before (despite Hornfels' best efforts).", 'TH_ZERO_G_CAVE_X1': "A cave at the very cent of Tember Hearth used by Outer Wilds Ventures to train new astronauts.", 'TH_ZERO_G_CAVE_X2': "I successfully repaired another \"satellite\" for Gossan.", 'TH_DARK_BRAMBLE_SEED_X1': "A seed from Dark Bramble crashed here and has already taken root. Tektite wants to use a scout launcher to get a look at what's inside.", 'TH_DARK_BRAMBLE_SEED_X2': "My signalscope picks up harmonica music when I aim it at the seed.", 'TH_DARK_BRAMBLE_SEED_X3': "I launched my Little Scout into the seed. Somehow the seed is much bigger on the inside.", 'TH_NOMAI_MINES_X1': "The Nomai mined ore from this site to craft a protective shell designed to physically seal off the central chamber inside Ash Twin.", 'TH_NOMAI_MINES_X2': "Once the shell was finished, the Nomai checked to ensure there were no longer any physical entrances or cracks.", 'TH_NOMAI_MINES_X3': "The Nomai discovered a species of four-eyed, semi-aquatic lifeforms in the waterways near the mine.", 'TH_QUANTUM_GROVE_X1': "There is a strange rock shard in this grove that moves when I'm not watching. It emits a signal on the Quantum Fluctuations frequency.", 'TH_QUANTUM_GROVE_X2': "I found a poem written on one of the trees in the grove.", 'TM_ESKERS_CAMP_X1': "Esker is growing a crop of trees at their camp. They seem to be doing okay, but they've probably been alone on the moon for too long.", 'TM_EYE_SIGNAL_LOCATOR_X1': "A Nomai device created to pinpoint the source of distant signals.", 'TM_EYE_SIGNAL_LOCATOR_X2': "The Nomai were disappointed by their failure to detect a signal from something called the Eye of the universe.", 'TM_LUNAR_LOOKOUT_X1': "A lookout platform with a spectacular view of the solar system. Esker uses their signalscope here to keep tabs on the other travelers.", 'BH_SOUTHERN_OBSERVATORY_X1': "The new, more sensitive locator the Nomai built in this observatory was unable to detect any trace of the Eye's signal.", 'BH_SOUTHERN_OBSERVATORY_X2': "Based on their knowledge of the Quantum Moon, the Nomai believed the Eye was in a distant orbit around the sun.", 'BH_SOUTHERN_OBSERVATORY_X3': "The Nomai decided to stop searching for the Eye's signal and instead look for it visually by sending out a deep space probe.", 'BH_SOUTHERN_OBSERVatory_X4': "There were concerns that the probability of launching a probe in the correct direction would be absurdly small.", 'BH_TORNADO_SIMULATION_X1': "Most Cycles on Giant's Deep rotate clockwise. These are the cyclones the Nomai used to send components into orbit.", 'BH_TORNADO_SIMULATION_X2': "There also exists a rarer type of cyclone that spins the opposite direction and pushes objects beneath the water and below the current.", 'BH_RIEBECKS_CAMP_X1': "Riebeck has set up camp at the bottom of the Crossroads. Their excitement at being surrounded by so much Nomai history is matched only by their terror of the black hole.", 'BH_RIEBECKS_CAMP_X2': "Riebeck is Timber Hearth's only archaeologist. They overcame their fear of space to explore Brittle Hollow's treasure trove of Nomai Culture.", 'BH_HANGING_CITY_X1': "A Nomai city suspended beneath Brittle Hollow's northern glacier. The city is divided vertically into four districts.", 'BH_HANGING_CITY_X2': "I found a switch in the Meltwater District that raises and lowers the Black Hole Forge.", 'BH_HANGING_CITY_X3': "The Nomai debated how to obtain the powerful, highly advanced warp core required for the Ash Twin Project.", 'BH_HANGING_CITY_X4': "The Nomai traveled to this solar system in pursuit of a signal from something older than the universe itself. They named the source of this signal the \"Eye of the universe.\"", 'BH_BLACK_HOLE_FORGE_X1': "A warp tower's alignment point is not its warp receiver. Rather, a warp tower always aligns with the center of its corresponding astral body.", 'BH_BLACK_HOLE_FORGE_X2': "The warp reciever must be located on (or in close orbit around) the relevant astral body.", 'BH_BLACK_HOLE_FORGE_X3': "The Hourglass Twins are so close together they function as a single astral body, with a shared alignment point in between them.", 'BH_BLACK_HOLE_FORGE_X4': "All of the warp towers were being constructed on Ash Twin, while the six warp receivers were being constructed at different locations.", 'BH_BLACK_HOLE_FORGE_X5': "A Nomai named Poke successfully forged an advanced warp core for the Ash Twin Project.", 'BH_ALIGNMENT_ANGLE_DIAGRAM_X1': "A diagram depicting the alignment angle between a warp tower and its corresonding astral body.", 'BH_ALIGNMENT_ANGLE_DIAGRAM_X2': "Warp tower alignment angles are not exact. They only need to be within five degrees of the astral body's center.", 'BH_ALIGNMENT_ANGLE_DIAGRAM_X3': "This results in slightly longer warp windows that last roughly several seconds.", 'BH_ALIGNMENT_ANGLE_DIAGRAM_X4': "Anyone stepping onto the warp platform during the active window will be immediately warped.", 'BH_NORTHERN_GLACIER_X1': "The north pole of Brittle Hollow is covered in snow and ice. There is a uniquely shaped Nomai Ruin on the surface.", 'BH_NORTHERN_GLACIER_X2': "The Nomai were able to warp here from the White Hole Station. This is where they first recreated warp technology.", 'BH_GRAVITY_CANNON_X1': "A huge cylindrical structure that generates a strong upward gravity field.", 'BH_GRAVITY_CANNON_X2': "I recalled a Nomai shuttle from the Quantum Moon.", 'BH_TOWER_OF_QUANTUM_KNOWLEDGE_X1': "The Nomai built a shrine on the Quantum Moon to aid in the pilgrimage to its sixth location. \"Remember this final rule: To explore the sixth location, the shrine must be on the moon's north pole.\"", 'BH_TOWER_OF_QUANTUM_KNOWLEDGE_X2': "The pilgrimage to the Quantum Moon was a deeply significant journey for the Nomai.", 'BH_TOWER_OF_QUANTUM_KNOWLEDGE_X3': "After the two groups of Nomai stranded on Ember Twin and Brittle Hollow were reuinited, it became their united goal to find and visit the Quantum Moon.", 'BH_QUANTUM_SHARD_X1': "A strange rock shard that wanders when no one is watching. The Nomai determined this shard is the reason objects in this grove behave in a quantum manner.", 'BH_QUANTUM_SHARD_X2': "The Nomai hypothesized that this shard is actually a piece of the Quantum Moon.", 'BH_QUANTUM_SHARD_X3': "This shard emits the same signal as the quantum Moon.", 'BH_ESCAPE_POD_X1': "One of three Nomai escape pods that crashed in our solar system.", 'BH_ESCAPE_POD_X2': "All three escape pods were launched from something called the Vessel, which was badly damaged.", 'BH_OLD_SETTLEMENT_X1': "The Nomai constructed a temporary settlement beneath their crashed escape pod.", 'BH_OLD_SETTLEMENT_X2': "The Nomai worked together to recall an eye-shaped signal they encountered while aboard the Vessel.", 'BH_OLD_SETTLEMENT_X3': "The signal was somehow older than the universe itself. The Nomai decided to call it the \"Eye of the universe.\"", 'BH_OLD_SETTLEMENT_X4': "The Nomai abandoned this settlement over growing concerns about its stability.", 'BH_OLD_SETTLEMENT_MURAL_1': "A mural of a Nomai vessel encountering a signal.", 'BH_OLD_SETTLEMENT_MURAL_2': "A mural of Dark Bramble ensnaring the Nomai vessel.", 'BH_OLD_SETTLEMENT_MURAL_3': "A mural of three escape pods evacuating the Nomai vessel.", 'VM_VOLCANIC_TESTING_SITE_X1': "Ore samples from the Nomai Mines on Timber Hearth were sent to his volcano for durability testing.", 'VM_VOLCANIC_TESTING_SITE_X2': "The Nomai were trying to craft a (briefly) supernova-proof shell to encase the Ash Twin Project.", 'VM_VOLCANIC_TESTING_SITE_X3': "Even the smallest crack or opening in the protective shell would destroy everything.", 'GD_GABBROS_ISLAND_X1': "Gabbro is lounging in a hammock near the island's shore.", 'GD_GABBROS_ISLAND_X2': "Gabbro found a Nomai statue on another island. The statue's eyes started glowing and Gabbro saw their memories flash before their eyes.", 'GD_GABBROS_ISLAND_X3': "Gabbro remembers dying. They saw their memories flash before their eyes, just like the time with the statue.", 'GD_GABBROS_ISLAND_X4': "Gabbro and I seem to be the only ones aware that we're in a time loop.", 'GD_STATUE_ISLAND_X1': "This island must be where the Nomai created statues like the one in our observatory.", 'GD_STATUE_ISLAND_X2': "I found a Nomai statue lying on the beach. It looks just like the one in our observatory.", 'GD_STATUE_WORKSHOP_X1': "Nomai statues were designed to pair with a single user, record their memories, and send those memories to a storage unit within the Ash Twin Project.", 'GD_STATUE_WORKSHOP_X2': "Each storage unit inside the ash Twin Project was equipped with a mask (the statue's counterpart), which could then send those stored memories back to the corresponding user.", 'GD_STATUE_WORKSHOP_X3': "The statues were designed to only activate once the Ash Twin Project succeeded, or in the event that it failed.", 'GD_OCEAN_DEPTHS_X1': "The ocean is surprisingly calm beneath the current. Some sort of electrical field surrounds the planet's core.", 'GD_OCEAN_DEPTHS_X2': "I passed through the electric barrier and reached the coral forest at the planet's core.", 'GD_CONSTRUCTION_YARD_X1': "This island is where the Nomai built the Orbital Probe Cannon.", 'GD_CONSTRUCTION_YARD_X2': "For some reason, the Nomai put the Orbital Probe Cannon on indefinite hiatus. The cannon was not asked to fire.", 'GD_CONSTRUCTION_YARD_X3': "According to a Nomai computer, a long-range probe was recently launched from the Orbital Probe Cannon.", 'GD_TOWER_OF_QUANTUM_TRIALS_X1': "This tower held knowledge a Nomai needed to make his or her first quantum journey.", 'GD_TOWER_OF_QUANTUM_TRIALS_X2': "\"Observing a quantum object; observing an image of a quantum object. These are the same.\"", 'GD_TOWER_OF_QUANTUM_TRIALS_X3': "The Nomai called this the \"Rule of Quantum Imaging.\"", 'GD_TOWER_OF_QUANTUM_TRIALS_X4': "\"Remember, the other quantum shards have other lessons to teach.\"", 'GD_BRAMBLE_ISLAND_X1': "An island of thorny vines and what appears to be a frozen jellyfish. It looks like Feldspar camped here before heading off to Dark Bramble.", 'OPC_CANNON_X1': "The broken remains of a Nomai space station in orbit around Giant's Deep. There are three accessways branching off from the central hub area.", 'OPC_CANNON_X2': "The Orbital Probe Cannon was created to find the precise location of the Eye of the universe.", 'OPC_CANNON_X3': "The Nomai pushed the Orbital Probe Cannon above its maximum power setting to create the greatest chance of finding the Eye of the universe.", 'OPC_PROBE_TRACKING_MODULE_X1': "The Orbital Probe Cannon has launched millions of probes.", 'OPC_PROBE_TRACKING_MODULE_X2': "The 9,318,054th probe located a deep space anomaly matching all known criteria for the Eye of the universe.", 'OPC_PROBE_TRACKING_MODULE_X3': "The Probe Tracking Module automatically records each probe's trajectory and transmits the data to the Ash Twin Project.", 'OPC_PROBE_TRACKING_MODULE_X4': "I found the Nomai coordinates marking the location of the Eye of the universe.", 'OPC_LAUNCH_MODULE_X1': "The launch module is badly damaged, but its projection pool is still intact.", 'OPC_LAUNCH_MODULE_X2': "A Nomai named Mallow argued that it wouldn't matter if the cannon's structural integrity was compromised, since they only needed to fire the probe once.", 'OPC_LAUNCH_MODULE_X3': "A Nomai named Privet countered that they wouldn't be capable of receiving the probe's data if the Probe Tracking Module was destroyed.", 'OPC_CONTROL_MODULE_X1': "The Control Module (recently) received a request from the Ash Twin Project to launch the probe. The cannon was aligned with a randomly selected probe trajectory.", 'OPC_CONTROL_MODULE_X2': "The probe was successfully launched, but the cannon's structural integrity was compromised in the process. Damage is detected in multiple modules.", 'DB_VESSEL_X1': "I found the derelict Nomai Vessel deep within Dark Bramble.", 'DB_VESSEL_X2': "The Vessel's warp core is long dead.", 'DB_VESSEL_X3': "I activated a three-sided pillar on the Vessel's bridge that appears to be some sort of input device.", 'DB_VESSEL_X4': "The nomai tried to call for help, but the Vessel's outgoing message system broke during the crash.", 'DB_VESSEL_X5': "The Vessel can still hear incoming messages from other Nomai vessels. The remaining Nomai clains are regrouping in response to the impending death of the universe.", 'DB_VESSEL_X6': "I found a recording of the original signal the Nomai encountered from the Eye of the universe. The Nomai were worried the signal might disappear, so they warped before they could tell another clan where they were going.", 'DB_FELDSPARS_CAMP_X1': "Feldspar is alive! They crashed their ship and is now camping inside a huge anglerfish skeleton.", 'DB_FELDSPARS_CAMP_X2': "Feldspar doesn't think my scout tracker is wrong when it says my scout is in two places at once. They have a theory that space doesn't work the same inside Dark Bramble.", 'DB_FELDSPARS_CAMP_X3': "Feldspar doesn't sound overly eager to return to civilization. They've been enjoying the (relative) peace and quiet.", 'DB_FROZEN_JELLYFISH_X1': "Feldspar documented their attemps to eat this enormous jellyfish frozen in the ice. The outside was all rubbery and tough, possibly because it insulates the jellyfish's insides from getting zapped by electricity.", 'DB_FROZEN_JELLYFISH_X2': "Feldspar decided to venture into the jellyfish's interior cavity to see if it tasted any better on the inside.", 'DB_FROZEN_JELLYFISH_X3': "After tasting the inside of the jellyfish, Feldspare conluded that these jellyfish are only useful for insulation from electricity.", 'DB_ESCAPE_POD_X1': "One of three Nomai escape pods that crashed in our solar system.", 'DB_ESCAPE_POD_X2': "All three escape pods were launched from something called the Vessel, which was badly damaged.", 'DB_ESCAPE_POD_X3': "The survivors from Escape Pod 3 detected two distinct beacons from the Vessel, as if it was in two locations at once.", 'DB_NOMAI_GRAVE_X1': "The survivors from Escape Pod 3 followed one of the two Vessel beacons to a small Dark Bramble seed, where they could go no further.", 'DB_NOMAI_GRAVE_X2': "The Nomai could faintly hear the Vessel's beacon from within the seed, but the opening was too small for a single Nomai to fit through, much less an escape pod.", 'DB_NOMAI_GRAVE_X3': "The Vessel's beacon was dying, and would soon be gone completely.", 'DB_NOMAI_GRAVE_X4': "If I launch my scout into the seed, I can take photos of an enormously derelict Nomai ship.", 'WHS_STATION_X1': "Every Nomai warp tower is tuned to a specific astral body.", 'WHS_STATION_X2': "To use a tower, you must be standing on the warp platform during the tower's alignment with its corresponding astral body (the alignment happens when the astral body is directly overhead).", 'WHS_STATION_X3': "The Nomai noticed something strange: Warped objects appeared to arrive at the receiver on Brittle Hollow slightly before they departed the White Hole Station.", 'WHS_STATION_X4': "This negative time interval between an object arriving and departing was incredibly miniscule (roughly one hundred-thousandth of a second). The Nomai were skeptical if their equipment could even measure time to such a small degree.", 'CT_SHUTTLE_X1': "I found a Nomai shuttle almost completely encased in ice.", 'CT_SHUTTLE_X2': "The Nomai landed on the Interloper not long after its arrival in the solar system. The shuttle's equipment heard strange energy readings coming from somewhere beneath the surface.", 'CT_SHUTTLE_X3': "There were three Nomai aboard the shuttle. One of them stayed behind to keep the shuttle warm while the other two explored the Interloper.", 'CT_SHUTTLE_X4': "Clary, the Nomai who stayed behind, lost contact with the other two after they descended below the Interloper's surface.", 'CT_RUPTURED_CORE_X1': "I found the two missing members of the Nomai shuttle crew near a large ruptured stone that looks like it exploded from the inside.", 'CT_RUPTURED_CORE_X2': "The Nomai traced the strange energy readings to a spherical stone casing filled with some form of exotic matter.", 'CT_RUPTURED_CORE_X3': "They determined the exotic matter was both lethal and under extreme pressure. If the stone were to rupture, the exotic matter within would rapidly expand, completely blanketing the solar system almost instantaneously.", 'CT_RUPTURED_CORE_X4': "One of the Nomai stayed behind to examine the alien matter while the other rushed back to the surface to warn the rest of the Nomai.", 'QM_MAIN_X1': "I was able to land on the surface of the Quantum Moon.", 'QM_MAIN_X2': "I found a dead Nomai in a space suit near the south pole.", 'QM_SHRINE_X1': "A Nomai shrine that wanders about the Quantum Moon.", 'QM_SHRINE_X2': "\"You have recalled the rule of quantum imaging\" is inscribed next to a mural of a tower on an island.", 'QM_SHRINE_X3': "\"Recall the rule of quantum entanglement\" is inscribed next to a mural of a quantum shard in a cave.", 'QM_SHRINE_X4': "\"Recall the rule of the sixth location\" is inscribed next to a mural of a tower hanging above a black hole.", 'QM_SIXTH_LOCATION_X1': "I met a living Nomai named Solanum at the south pole!", 'QM_SIXTH_LOCATION_X2': "The Quantum Moon is the Eye of the universe's moon.", 'QM_SIXTH_LOCATION_X3': "At this location, the Quantum Moon becomes a reflection of the Eye itself.", 'QM_SIXTH_LOCATION_X4': "The Eye is likely the source of all macroscopic quantum phenomena in this solar system.", 'QM_SIXTH_LOCATION_X5': "Solanum wonders what would happen if a concious observer were to enter the Eye.", 'QM_SIXTH_LOCATION_X6': "Solanum has a hypothesis that she may not be entirely alive.", 'QM_SHUTTLE_X1': "A Nomai named Solanum landed her shuttle at the Quantum Moon's south pole and prepared to make the rest of the journey on foot.", 'QM_SHUTTLE_X2': "Visitors to the Quantum Moon always arrive at the south pole (for reasons unknown to the Nomai)."
        };

        // --- DOM Elements ---
        const uploadSection = document.getElementById('upload-section');
        const fileUpload = document.getElementById('file-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const analysisOutput = document.getElementById('analysis-output');
        const spoilerToggle = document.getElementById('spoiler-toggle');
        const resetButton = document.getElementById('reset-button');
        const spoilerModal = document.getElementById('spoiler-warning-modal');
        const confirmRevealButton = document.getElementById('confirm-reveal-button');
        const cancelRevealButton = document.getElementById('cancel-reveal-button');
        const dismissWarningCheckbox = document.getElementById('dismiss-spoiler-warning');
        const detailedShipLogContainer = document.getElementById('detailed-ship-log');

        // --- Event Listeners ---
        fileUpload.addEventListener('change', (event) => handleFile(event.target.files[0]));
        resetButton.addEventListener('click', resetView);
        
        spoilerToggle.addEventListener('change', () => {
            if (currentSaveData) {
                renderShipLogsSummary(currentSaveData, spoilerToggle.checked);
                renderDetailedShipLog(currentSaveData, spoilerToggle.checked);
            }
        });

        // Setup Drag and Drop
        const uploadLabel = document.querySelector('.file-upload-label');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadLabel.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadLabel.addEventListener(eventName, () => uploadLabel.classList.add('bg-gray-600'));
        });
        ['dragleave', 'drop'].forEach(eventName => {
            uploadLabel.addEventListener(eventName, () => uploadLabel.classList.remove('bg-gray-600'));
        });
        uploadLabel.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
        
        // Event listeners for the modal
        cancelRevealButton.addEventListener('click', () => spoilerModal.classList.add('hidden'));
        confirmRevealButton.addEventListener('click', () => {
            if (activeSpoilerElement) {
                activeSpoilerElement.classList.add('revealed');
            }
            if(dismissWarningCheckbox.checked) {
                spoilerWarningDismissed = true;
            }
            spoilerModal.classList.add('hidden');
        });

        // Delegated event listener for collapsible headers and individual spoilers
        detailedShipLogContainer.addEventListener('click', (e) => {
            // Handle collapsible clicks
            const header = e.target.closest('.collapsible-header');
            if (header) {
                const content = header.nextElementSibling;
                const chevron = header.querySelector('.chevron');
                content.classList.toggle('hidden');
                chevron.classList.toggle('collapsed');
                return; // Stop further processing
            }

            // Handle individual spoiler clicks
            const spoiler = e.target.closest('.spoiler:not(.revealed)');
            if (spoiler) {
                if (spoilerWarningDismissed) {
                    spoiler.classList.add('revealed');
                } else {
                    activeSpoilerElement = spoiler;
                    spoilerModal.classList.remove('hidden');
                }
            }
        });

        // --- Core Functions ---
        function handleFile(file) {
            if (file && file.name.endsWith('.owsave')) {
                fileNameDisplay.textContent = file.name;
                processFile(file);
            } else {
                fileNameDisplay.textContent = "Invalid file. Please upload a '.owsave' file.";
            }
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const arrayBuffer = e.target.result;
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    // Check if this is a .NET binary serialized file
                    if (isBinaryFile(uint8Array)) {
                        currentSaveData = handleBinaryFile(uint8Array);
                        if (currentSaveData) {
                            displayAnalysis(currentSaveData);
                        }
                    } else {
                        fileNameDisplay.textContent = 'Error: Unsupported file format. Only .NET binary serialized save files are supported.';
                        currentSaveData = null;
                    }
                } catch (error) {
                    console.error('Error processing save file:', error);
                    fileNameDisplay.textContent = 'Error: Could not process file. Please ensure it is a valid .owsave file.';
                    currentSaveData = null;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function isBinaryFile(uint8Array) {
            // Check for .NET binary serialization markers
            const text = String.fromCharCode.apply(null, uint8Array.slice(0, 100));
            return text.includes('Assembly-CSharp') || text.includes('GameSave') || text.includes('System.Collections.Generic');
        }

        function handleBinaryFile(uint8Array) {
            // Display informative error message for binary files
            fileNameDisplay.innerHTML = `
                <div class="text-left bg-red-900/20 border border-red-500/50 rounded-lg p-3 mt-2">
                    <div class="text-red-400 font-semibold mb-2">🚫 Binary File Format Not Supported</div>
                    <div class="text-sm text-gray-300 space-y-1">
                        <p><strong>Detected:</strong> .NET Binary Serialized Save File</p>
                        <p><strong>Size:</strong> ${uint8Array.length} bytes</p>
                        <p><strong>Status:</strong> This tool currently only supports parsed save data, not binary files.</p>
                    </div>
                    <div class="text-xs text-gray-400 mt-3 p-2 bg-gray-800/50 rounded">
                        <strong>Technical Details:</strong> Your save file is a .NET binary serialized file containing game state data. 
                        This format requires specialized parsing to extract the game progress information.
                    </div>
                </div>
            `;
            return null;
        }

        function resetView() {
            uploadSection.classList.remove('hidden');
            analysisOutput.classList.add('hidden');
            fileUpload.value = '';
            fileNameDisplay.textContent = 'No file selected';
            currentSaveData = null;
            spoilerToggle.checked = false;
            spoilerWarningDismissed = false;
            dismissWarningCheckbox.checked = false;
        }

        function displayAnalysis(data) {
            uploadSection.classList.add('hidden');
            analysisOutput.classList.remove('hidden');
            renderGameProgress(data);
            renderShipLogsSummary(data, spoilerToggle.checked);
            renderKeyConditions(data);
            renderMajorLocations(data);
            renderDetailedShipLog(data, spoilerToggle.checked);
        }

        // --- Rendering Functions ---
        function renderGameProgress(data) {
            const container = document.getElementById('game-progress');
            const knownSignalsCount = Object.values(data.knownSignals || {}).filter(v => v).length;
            const totalSignals = Object.keys(data.knownSignals || {}).length;
            let html = `<h3 class="text-xl font-semibold mb-4 text-white">Game Progress</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            ${createStatCard('Loops Completed', data.loopCount || 0)}
                            ${createStatCard('Full Timeloops', data.fullTimeloops || 0)}
                            ${createStatCard('Signals Found', `${knownSignalsCount} / ${totalSignals}`)}
                            ${createStatCard('Last Death', data.lastDeathType || 'N/A')}
                        </div>`;
            container.innerHTML = html;
        }
        
        function createStatCard(label, value) {
            return `<div class="bg-gray-800 p-4 rounded-lg">
                        <p class="text-sm text-gray-400">${label}</p>
                        <p class="text-2xl font-bold text-white break-words">${value}</p>
                    </div>`;
        }

        function renderShipLogsSummary(data, showSpoilers) {
            const container = document.getElementById('ship-logs-summary');
            const foundEntriesCount = Object.keys(data.shipLogFactSaves || {}).filter(id => data.shipLogFactSaves[id].read).length;
            const totalKnownLogs = Object.keys(shipLogMapping).length;
            
            const totalText = showSpoilers ? `/ ${totalKnownLogs}` : '/ <span class="spoiler">??</span>';

            let html = `<h3 class="text-xl font-semibold mb-4 text-white">Ship Log Summary</h3>
                        <div class="bg-gray-800 p-4 rounded-lg flex flex-col justify-center items-center">
                            <p class="text-4xl font-bold text-white">${foundEntriesCount} ${totalText}</p>
                            <p class="text-lg text-gray-300">Entries Discovered</p>
                            <div class="w-full bg-gray-600 rounded-full h-2.5 mt-2">
                              <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${(totalKnownLogs > 0 ? (foundEntriesCount/totalKnownLogs)*100 : 0)}%"></div>
                            </div>
                        </div>`;
            container.innerHTML = html;
        }
        
        function renderKeyConditions(data) {
            const container = document.getElementById('key-conditions');
            let html = `<h3 class="text-xl font-semibold mb-4 text-white">Key Story Milestones</h3>
                        <ul class="space-y-2">`;
            for (const [condition, description] of Object.entries(storyConditions)) {
                 const status = data.dictConditions?.[condition] ? 
                    '<span class="text-green-400 font-bold">✓</span>' : 
                    '<span class="text-red-400 font-bold">✗</span>';
                html += `<li class="flex items-center bg-gray-800 p-3 rounded-lg">${status}<span class="ml-3">${description}</span></li>`;
            }
            html += `</ul>`;
            container.innerHTML = html;
        }
        
        function renderMajorLocations(data) {
            const container = document.getElementById('major-locations');
            const locationCounts = {};
            for (const entry_id in data.shipLogFactSaves) {
                if (data.shipLogFactSaves[entry_id].read) {
                    const prefix = entry_id.split('_')[0];
                    locationCounts[prefix] = (locationCounts[prefix] || 0) + 1;
                }
            }
            
            let html = `<h3 class="text-xl font-semibold mb-4 text-white">Exploration by Location</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">`;
            const sortedLocations = Object.entries(locationCounts).sort((a,b) => b[1] - a[1]);

            if(sortedLocations.length > 0) {
                 sortedLocations.forEach(([prefix, count]) => {
                    const locationName = locationNames[prefix] || prefix;
                    html += `<div class="bg-gray-800 p-3 rounded-lg text-center">
                                <p class="font-semibold text-white">${locationName}</p>
                                <p class="text-sm text-gray-400">${count} entries found</p>
                            </div>`;
                });
            } else {
                 html += `<p class="col-span-full text-center text-gray-400">No logs discovered yet.</p>`;
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        function getHierarchicalLogs() {
            const grouped = {};
            function formatRegionName(name) {
                return name.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
            }

            for (const [id, text] of Object.entries(shipLogMapping)) {
                const parts = id.split('_');
                const planetCode = parts[0];
                const regionCode = parts.slice(0, -1).join('_');

                if (!grouped[planetCode]) {
                    grouped[planetCode] = {
                        name: locationNames[planetCode] || planetCode,
                        regions: {}
                    };
                }
                if (!grouped[planetCode].regions[regionCode]) {
                    grouped[planetCode].regions[regionCode] = {
                        name: formatRegionName(parts.slice(1, -1).join('_')),
                        entries: []
                    };
                }
                grouped[planetCode].regions[regionCode].entries.push({ id, text });
            }
            return grouped;
        }

        function renderDetailedShipLog(data, showSpoilers) {
            const savedEntries = data.shipLogFactSaves || {};
            const groupedLogs = getHierarchicalLogs();
            let html = `<h3 class="text-xl font-semibold mb-4 text-white">Detailed Ship Log</h3>`;
            html += `<div class="space-y-4">`;

            const chevronSVG = `<svg class="chevron collapsed w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;

            const sortedPlanetCodes = Object.keys(groupedLogs).sort((a, b) => groupedLogs[a].name.localeCompare(groupedLogs[b].name));
            
            for (const planetCode of sortedPlanetCodes) {
                const planet = groupedLogs[planetCode];
                html += `<div class="bg-gray-800/50 rounded-lg">
                            <div class="collapsible-header p-3">
                                ${chevronSVG}
                                <h4 class="text-lg font-semibold text-indigo-400">${planet.name}</h4>
                            </div>
                            <div class="planet-content hidden pl-6 pr-3 pb-3 space-y-3">`;

                const sortedRegionCodes = Object.keys(planet.regions).sort((a, b) => planet.regions[a].name.localeCompare(planet.regions[b].name));

                for(const regionCode of sortedRegionCodes) {
                    const region = planet.regions[regionCode];
                    html += `<div class="bg-gray-900/40 rounded-lg">
                                <div class="collapsible-header p-2">
                                    ${chevronSVG}
                                    <h5 class="font-semibold text-gray-300">${region.name}</h5>
                                </div>
                                <div class="region-content hidden p-3 space-y-3">
                                    <ul class="space-y-3">`;

                    for (const entry of region.entries) {
                        const isFound = savedEntries[entry.id] && savedEntries[entry.id].read;
                        const spoilerClass = showSpoilers ? 'revealed' : '';

                        if (isFound) {
                             html += `<li>
                                        <strong class="font-medium text-gray-300 flex items-center"><span class="text-green-400 mr-2">✓</span>${entry.id}</strong>
                                        <div class="log-entry-text text-gray-400">${entry.text}</div>
                                     </li>`;
                        } else {
                            html += `<li class="entry-unfound">
                                        <strong class="font-medium text-gray-300 flex items-center"><span class="text-red-500 mr-2">✗</span>${entry.id}</strong>
                                        <div class="log-entry-text text-gray-400"><span class="spoiler ${spoilerClass}">${entry.text}</span></div>
                                     </li>`;
                        }
                    }
                    html += `</ul></div></div>`; // Close region-content and region-container
                }
                html += `</div></div>`; // Close planet-content and planet-container
            }

            html += `</div>`;
            detailedShipLogContainer.innerHTML = html;
        }

    </script>
</body>
</html>
